<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Call Controls with WebSocket</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="jquery-3.5.1.min.js"></script>
    <script src="script.js"></script>
</head>
<body>

    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-12 col-md-6">
                <h2 class="text-center">Web Call Controls</h2>
                <div class="card">
                    <div class="card-body">
                        <!-- Call Status Display -->
                        <div class="alert alert-info" id="callStatus">Waiting for call...</div>

                        <!-- Buttons for Call Actions -->
                        <div class="form-group">
                            <label for="makecallNumber">Enter the Phone:</label>
                            <input type="text" id="makecallNumber" class="form-control" placeholder="Enter Number">
                            <small id="error-message" class="text-danger"></small>
                        </div>
                        <button id="makeCall" class="btn btn-info btn-lg btn-block mb-3" disabled>Make Call</button>
                        <button id="acceptCall" class="btn btn-success btn-lg btn-block mb-3" disabled>Accept Call</button>
                        <button id="holdCall" class="btn btn-warning btn-lg btn-block mb-3" disabled>Hold Call</button>
                        <button id="unholdCall" class="btn btn-primary btn-lg btn-block mb-3" disabled>Unhold Call</button>
                        <button id="transferCall" class="btn btn-danger btn-lg btn-block mb-3" disabled>Transfer Call</button>
                        <button id="checkbroadcast" class="btn btn-secondary btn-lg btn-block mb-3">Get Agent Call Status</button>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <!--<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>-->

    <script>
        // WebSocket initialization and event handling
        $(document).ready(function () {
            

            $(document).on('subscribecallevents', function (event) {
                var parsedData = JSON.parse(event.originalEvent.detail); // Assuming server sends JSON data
                var data = JSON.parse(parsedData.response);


                if (data.callStatus === 'alerting') {
                    var msglabel = "Incoming Call Alerting - " + ((data.response != "" && data.response != undefined) ? data.response : "");
                    updateCallStatus(msglabel);
                    $('#makeCall').prop('disabled', true);   // Disable Make Call
                    $('#acceptCall').prop('disabled', false);  // Enable Accept Call
                    $('#holdCall').prop('disabled', true);     // Disable Hold Call
                    $('#unholdCall').prop('disabled', true);   // Disable Unhold Call
                    $('#transferCall').prop('disabled', true); // Disable Transfer Call
                } else if (data.callStatus === 'active') {
                    updateCallStatus("Active");
                    $('#makeCall').prop('disabled', true);   // Disable Make Call
                    $('#acceptCall').prop('disabled', true);   // Disable Accept Call
                    $('#holdCall').prop('disabled', false);    // Enable Hold Call
                    $('#unholdCall').prop('disabled', false);  // Enable Unhold Call
                    $('#transferCall').prop('disabled', false);// Enable Transfer Call
                } else if (data.callStatus === 'on_hold') {
                    updateCallStatus("On Hold");
                    $('#makeCall').prop('disabled', true);   // Disable Make Call
                    $('#acceptCall').prop('disabled', true);   // Disable Accept Call
                    $('#holdCall').prop('disabled', true);     // Disable Hold Call
                    $('#unholdCall').prop('disabled', false);  // Enable Unhold Call
                    $('#transferCall').prop('disabled', false);// Enable Transfer Call
                } else if (data.callStatus === 'idle') {
                    var msglabel =((data.response != "" && data.response != undefined) ? data.response : "Idle");
                    updateCallStatus(msglabel);
                    $("#error-message").text("");
                    $('#makeCall').prop('disabled', false);   // Enable Make Call
                    $('#acceptCall').prop('disabled', true);   // Disable Accept Call
                    $('#holdCall').prop('disabled', true);     // Disable Hold Call
                    $('#unholdCall').prop('disabled', true);   // Disable Unhold Call
                    $('#transferCall').prop('disabled', true); // Disable Transfer Call
                }

            });


            // Update the UI with the received call status
            function updateCallStatus(status) {
                $('#callStatus').text('Call Status: ' + status);
            }

            // Handle Accept Call
            $('#acceptCall').click(function () {
                var event = new CustomEvent('broadcastcallevents', {
                    detail: {
                        action: "Accept"
                    }
                });
                document.dispatchEvent(event);
            });


            // Handle Make Call
            $('#makeCall').click(function () {
                var transferNumber = $('#makecallNumber').val().trim();
                if (transferNumber != undefined && transferNumber != null && transferNumber!="") {
                   
                    var event = new CustomEvent('broadcastcallevents', {
                        detail: {
                            action: "MakeCall",
                            values: transferNumber
                        }
                    });
                    document.dispatchEvent(event);
                } else {
                    $("#error-message").text("Enter a phone number.");

                }
            });


            // Handle Hold Call
            $('#holdCall').click(function () {
                var event = new CustomEvent('broadcastcallevents', {
                    detail: {
                        action: "Hold"
                    }
                });
                document.dispatchEvent(event);
            });

            // Handle Unhold Call
            $('#unholdCall').click(function () {
                var event = new CustomEvent('broadcastcallevents', {
                    detail: {
                        action: "UnHold"
                    }
                });
                document.dispatchEvent(event);
            });

            $('#checkbroadcast').click(function () {
                var event = new CustomEvent('broadcastcallevents', {
                    detail: {
                        action: "AgentState"
                    }
                });

                document.dispatchEvent(event);
            });

            // Handle Transfer Call
            $('#transferCall').click(function () {
                var transferNumber = $('#makecallNumber').val().trim();
                if (transferNumber) {
                    var event = new CustomEvent('broadcastcallevents', {
                        detail: {
                            action: "Transfer",
                            values: transferNumber
                        }
                    });

                    document.dispatchEvent(event);
                } else {
                    alert('Please enter a transfer number');
                }
            });



        });



    </script>

</body>
</html>
